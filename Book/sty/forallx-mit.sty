%!TEX root = ../forallx-mit.tex

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{forallx-mit}[2024/01/01 ForAllX MIT logic textbook style]

% ========================================
% REQUIRED PACKAGES
% ========================================
% This section loads all the LaTeX packages required by the style file.
% Each package serves a specific purpose in formatting the logic textbook.

\RequirePackage[dvipsnames]{xcolor}        % Extended color support with named colors
\RequirePackage{enumitem}                  % Enhanced control over lists (enumerate, itemize)
\RequirePackage{graphicx}                  % Include graphics and images
\RequirePackage{adjustbox}                 % Adjust size and position of boxes
\RequirePackage{amssymb}                   % AMS mathematical symbols
\RequirePackage{colonequals}               % Colon-equals symbols (e.g., :=)
\RequirePackage{amsmath}                   % AMS mathematical environments
\RequirePackage{mathabx}                   % Additional mathematical symbols
\RequirePackage{lmodern}                   % Latin Modern fonts (better than default)
\RequirePackage{microtype}                 % Improved typography (character protrusion, font expansion)
\RequirePackage{multicol}                  % Multiple column layouts
\RequirePackage{ifthen}                    % Conditional statements in LaTeX
\RequirePackage{prooftrees}                % Package for typesetting proof trees
\RequirePackage{titlesec}                  % Customize section titles
\RequirePackage{apptools}                  % Tools for appendices
\RequirePackage{mathtools}                 % Extension of amsmath
\RequirePackage{amsthm}                    % Theorem environments
\RequirePackage{lipsum}                    % Lorem ipsum text (for testing)
\RequirePackage{fancyhdr}                  % Fancy headers and footers
\RequirePackage{mdwtab}                    % Enhanced tabular environments
\RequirePackage{latexsym}                  % LaTeX symbols

% ========================================
% HYPERREF SETUP
% ========================================
% Configure hyperlinks in the PDF output. This makes the document interactive
% with clickable links for references, citations, and URLs.

\RequirePackage[linktocpage=true]{hyperref}  % Make page numbers (not titles) clickable in TOC
\definecolor{URLblue}{RGB}{0,0,150}          % Define a custom blue color for links
\hypersetup{
    colorlinks   = true,                      % Use colored text for links (not boxes)
    urlcolor     = URLblue,                   % Color for external URLs
    linkcolor    = URLblue,                   % Color for internal links (sections, pages)
    citecolor    = red                        % Color for citation links
}

% ========================================
% PAGE LAYOUT
% ========================================
% Basic page layout settings

\raggedbottom  % Don't stretch vertical space to fill pages
               % This prevents awkward spacing, especially with large proof trees

% ========================================
% LOGICAL SYMBOLS
% ========================================
% Define commands for logical connectives. This allows easy customization
% of logical notation throughout the book. To change notation, simply
% modify these definitions.

\def\therefore{\ensuremath{\ldotp\dot{}\,\ldotp}}  % Therefore symbol (three dots)
\def\eor{\ensuremath{\vee}}                         % Disjunction (logical OR)
\def\eand{\ensuremath{\wedge}}                      % Conjunction (logical AND)
\def\eif{\ensuremath{\rightarrow}}                  % Conditional (if...then)
\def\eiff{\ensuremath{\leftrightarrow}}             % Biconditional (if and only if)
\def\enot{\ensuremath{\neg}}                        % Negation (logical NOT)

% ========================================
% MATHEMATICAL NOTATION
% ========================================
% Commands for common mathematical constructs used in logic

% Common commands
\renewcommand{\vert}[1]{\lvert#1\rvert}             % Vertical bars for absolute value
\newcommand{\corner}[1]{\ulcorner#1\urcorner}      % Corner quotes (Quine quotes)
\newcommand{\concat}[2]{{#1}{\raisebox{4pt}{\smallfrown}}{#2}}  % String concatenation
\newcommand{\tuple}[1]{\langle#1\rangle}            % Angle brackets for tuples
\newcommand{\set}[1]{\lbrace#1\rbrace}              % Curly braces for sets

% Mathematical symbols - Calligraphic and blackboard bold letters
\newcommand{\I}{\mathcal{I}}        % Interpretation function
\newcommand{\J}{\mathcal{J}}        % Alternative interpretation
\newcommand{\B}{\mathcal{B}}        % Base/Boolean domain
\newcommand{\M}{\mathcal{M}}        % Model
\newcommand{\N}{\mathbb{N}}         % Natural numbers
\newcommand{\PL}{\mathcal{L}^{\textsc{pl}}}        % Propositional logic language
\newcommand{\FOL}{\mathcal{L}^{\textsc{fol}}}      % First-order logic language
\newcommand{\FI}{\mathcal{L}^{=}}                   % First-order logic with identity
\newcommand{\FIN}{\mathcal{L}^{=}_{\mathbb{N}}}    % FOL with identity over naturals
\newcommand{\C}{\mathbb{C}}         % Complex numbers (or arbitrary constant)
\newcommand{\F}{\mathcal{F}}        % Function symbols
\newcommand{\D}{\mathbb{D}}         % Domain

% Text commands for special functions
\newcommand{\length}{\texttt{Length}}  % Length function
\newcommand{\comp}{\texttt{Comp}}      % Complexity function
\newcommand{\res}{\texttt{Res}}        % Resolution/restriction

% Mathematical structures
\newcommand{\T}{\mathcal{T}}           % Theory
\newcommand{\V}[1]{\mathcal{V}_{#1}}   % Valuation function with subscript
\newcommand{\VV}[2]{\mathcal{V}_{#1}^{#2}}  % Valuation with sub and superscript
\newcommand{\val}[2]{\mathscr{v}_{#1}^{#2}}  % Alternative valuation notation
\newcommand{\ext}[3]{|#1|_{#2}^{#3}}   % Extension in a model
\newcommand{\va}[1]{\hat{#1}}          % Variable with hat
\renewcommand{\v}[1]{\mathbf{#1}}      % Bold vector notation

% Deduction symbols - turnstile variants
\newcommand{\plvdash}{\vdash_{\textsc{pl}}}     % PL syntactic consequence
\newcommand{\plvDash}{\vDash_{\PL}}              % PL semantic consequence
\newcommand{\fivdash}{\vdash_{\textsc{fol}^=}}  % FOL with identity syntactic consequence
\newcommand{\fivDash}{\vDash_{\FI}}              % FOL with identity semantic consequence

% Additional logical symbols
\def\ered{\ensuremath{\bot}}           % Bottom/falsum/absurdity
\def\proves{\ensuremath{\vdash}}        % Proves (syntactic consequence)
\def\entails{\ensuremath{\vDash}}       % Entails (semantic consequence)
\def\nproves{\ensuremath{\nvdash}}      % Does not prove
\def\nentails{\ensuremath{\nvDash}}     % Does not entail

\let\oldemptyset\emptyset               % Save old empty set symbol
\let\emptyset\varnothing                % Use the better-looking empty set symbol

% Quantifier and substitution notation
\newcommand{\qt}[2]{#1 #2}              % Quantifier-variable pairs
\newcommand{\unisub}[2]{[#1/#2]}        % Uniform substitution notation
\newcommand{\freesub}[2]{(#1/#2)}       % Free substitution notation

% ========================================
% META-LANGUAGE VARIABLES
% ========================================
% Greek letters used as metavariables for formulas and sets of formulas

\def\metaA{\ensuremath{\varphi}}        % Formula metavariable (phi)
\def\metaB{\ensuremath{\psi}}           % Formula metavariable (psi)
\def\metaC{\ensuremath{\chi}}           % Formula metavariable (chi)
\def\metaD{\ensuremath{\delta}}         % Formula metavariable (delta)
\def\metaG{\ensuremath{\gamma}}         % Formula metavariable (gamma)
\def\MetaG{\ensuremath{\Gamma}}         % Set of formulas (capital Gamma)
\def\MetaS{\ensuremath{\Sigma}}         % Set of formulas (capital Sigma)
\def\MetaD{\ensuremath{\Delta}}         % Set of formulas (capital Delta)
\def\metaSetX{\ensuremath{\Gamma}}      % Generic formula set X
\def\metaSetY{\ensuremath{\Sigma}}      % Generic formula set Y
\def\metaSetZ{\ensuremath{\varPhi}}     % Generic formula set Z

% ========================================
% THEOREM ENVIRONMENTS
% ========================================
% Define various theorem-like environments with custom styling and numbering

% Theorem style and environment
\newtheoremstyle{Tthm}
{.3in}{}{\normalfont}{}{\bfseries}{}{.18in}{}  % Space above, below, body font, indent, head font, punctuation, space after head, head spec
\theoremstyle{Tthm}
\newtheorem{Tthm}{}[chapter]                    % Reset theorem counter each chapter
\renewcommand{\theTthm}{Theorem \arabic{chapter}.\arabic{Tthm}}  % Format: "Theorem 3.2"

% Lemma style and environment
\newtheoremstyle{Lthm}
{.3in}{}{\normalfont}{}{\bfseries}{}{.18in}{}
\theoremstyle{Lthm}
\newtheorem{Lthm}{}[chapter]
\renewcommand{\theLthm}{Lemma \arabic{chapter}.\arabic{Lthm}}

% Corollary style and environment
\newtheoremstyle{Cthm}
{.3in}{}{\normalfont}{}{\bfseries}{}{.18in}{}
\theoremstyle{Cthm}
\newtheorem{Cthm}{}[chapter]
\renewcommand{\theCthm}{Corollary \arabic{chapter}.\arabic{Cthm}}

% Rule style and environment (for inference rules)
\newtheoremstyle{Rthm}
{}{}{\normalfont}{}{\bfseries}{}{4pt}{}
\theoremstyle{Rthm}
\newtheorem{Rthm}{}[chapter]
\renewcommand{\theRthm}{Rule \arabic{Rthm}}

% Problem style and environment
\newtheoremstyle{Pthm}
{}{}{\normalfont}{}{\bfseries}{}{.18in}{}
\theoremstyle{Pthm}
\newtheorem{Pthm}{}[subsection]
\renewcommand{\thePthm}{P\arabic{Pthm}}

% Bold reference command
\newcommand{\bref}[1]{\textbf{\ref{#1}}}  % Bold cross-references

% ========================================
% TITLE AND VERSION
% ========================================
% Book title and automatic version numbering based on compilation date

\newcommand*{\forallx}{{\tt forall\script{x}}}  % Stylized book title
\newcounter{dummy}
\setcounter{dummy}{\year}
\addtocounter{dummy}{-2000}
% Version number format: YYMMDD (e.g., 240115 for Jan 15, 2024)
\newcommand*{\bookversion}{%
    \ifthenelse{\arabic{dummy}<10}{0}{}%
    \arabic{dummy}%
    \ifthenelse{\month<10}{0}{}\number\month%
    \ifthenelse{\day<10}{0}{}\number\day%
}  

% ========================================
% FONTS AND TYPOGRAPHY
% ========================================
% Special fonts and typographical elements

% Zapf Chancery for script letters
\DeclareFontFamily{OT1}{pzc}{}
\DeclareFontShape{OT1}{pzc}{m}{it}{<-> s * [1.200] pzcmi7t}{}
\DeclareMathAlphabet{\mathscr}{OT1}{pzc}{m}{it}
\newcommand*{\script}[1]{\ensuremath{\mathscr{#1}}}  % Script letters

% Typography commands
\newcommand*{\blank}{\underline{\hspace*{2.5em}}}    % Blank line for fill-in
\newcommand*{\gap}[1]{\blank$_{#1}$}                 % Numbered gap for exercises
\newcommand*{\define}[1]{\textsc{\lowercase{#1}}}    % Small caps for defined terms

% ========================================
% SEMANTIC NOTATION
% ========================================
% Commands for model theory and formal semantics

\renewcommand{\models}{\vDash}          % Models relation
\newcommand{\nmodels}{\nvDash}          % Does not model
\newcommand*{\model}[1]{\ensuremath{\mathbb{#1}}}   % Blackboard bold for models
\newcommand*{\extension}[1]{\ensuremath{\mbox{extension}(#1)}}  % Extension function
\newcommand*{\referent}[1]{\ensuremath{\mbox{referent}(#1)}}    % Referent function
\newcommand*{\openntuple}{\langle}      % Opening angle bracket
\newcommand*{\closentuple}{\rangle}     % Closing angle bracket
\newcommand*{\ntuple}[1]{\mbox{\ensuremath{\mathopen{\openntuple}}#1\ensuremath{\mathclose{\closentuple}}}}  % n-tuple notation

% ========================================
% LIST ENVIRONMENTS
% ========================================
% Custom list environments for arguments, examples, and keys

% Counters for custom lists
\newcounter{eargletter}[chapter]        % Letter counter for arguments (resets per chapter)
\renewcommand{\theeargletter}{\Alph{eargletter}}
\newcounter{eargnum}[eargletter]        % Number counter within each letter

% earg environment: For listing arguments with labels like A1, A2, B1, B2
\newenvironment{earg}[1][]
{%
  \refstepcounter{eargletter}%
  \begin{enumerate}[label=\Alph{eargletter}\arabic{eargnum}., #1]%
  \usecounter{eargnum}
  \setlength{\itemsep}{-.4em}%          % Reduce vertical space between items
}
{\end{enumerate}}

% oarg environment: For custom prefix labels
\newenvironment{oarg}[1][]
{%
  \def\customprefix{#1}%
  \begin{enumerate}[label=\customprefix\arabic{eargnum}.]%
  \usecounter{eargnum}
  \setlength{\itemsep}{-.4em}%
}
{\end{enumerate}}

% Custom item commands
\newcommand{\eitem}[1]{%                % Regular item in earg
  \refstepcounter{eargnum}%
  \item[\Alph{eargletter}\arabic{eargnum}.] {#1}
  \label{\theeargnum}
}

\newcommand{\uitem}[1]{%                % Underlined item (for conclusions)
  \refstepcounter{eargnum}%
  \item[\Alph{eargletter}\arabic{eargnum}.] \underline{#1}\vspace{2pt}
  \label{\theeargnum}
}

\newcommand{\oeitem}[1]{%               % Regular item in oarg
  \refstepcounter{eargnum}%
  \item[\customprefix\arabic{eargnum}.] {#1}
}

\newcommand{\ouitem}[1]{%               % Underlined item in oarg
  \refstepcounter{eargnum}%
  \item[\customprefix\arabic{eargnum}.] \underline{#1}\vspace{2pt}
}

\newcommand{\eref}[2]{\ref{#1}\ref{#2}} % Reference two items at once

% Other list environments
\newenvironment{ebullet}                % Compact bullet list
{\begin{list}{\textbullet}{\itemsep=0pt \parsep=0pt}}
{\end{list}}

\newcommand{\ekeylabel}[1]{{\makebox[8ex][r]{\textbf{ #1}}}}  % Label for key items

\newenvironment{ekey}[1][]              % Environment for symbolization keys
{\begin{enumerate}[#1]\setlength{\itemsep}{-.4em}}
{\end{enumerate}}

% Example counter and command
\newcounter{Example}[chapter]
\newcommand*{\ex}[1]{\refstepcounter{Example}\arabic{Example}.\label{#1}}

% Partial model environment (for model theory)
\newenvironment{partialmodel}{\par\begin{tabular}{r@{~=~}l}}{\end{tabular}\par}

% Factoid box for important definitions or facts
\newcommand{\factoidbox}[1]{%
  \setlength{\fboxsep}{10pt}%           % Padding inside the box
  \begin{quote}
    \framebox{\parbox{\dimexpr\linewidth-2\fboxsep\relax}{#1}}%
  \end{quote}%
}

% Table box for framed table cells
\newcommand{\tablefbox}[1]{\multicolumn{1}{|p{10em}|}{#1}}

% ========================================
% PRACTICE PROBLEMS
% ========================================
% Commands for practice problems and solutions

\newcounter{ProbPart}[chapter]          % Problem part counter
\renewcommand{\theProbPart}{\Alph{ProbPart}}

% Practice problems for a specific chapter
\newcommand*{\practiceproblemsA}[1]{
    \phantomsection                     % For hyperref
    \setcounter{ProbPart}{0}\section*{Practice Exercises for Chapter {\ref{#1}}}
    \addcontentsline{toc}{section}{Exercises for Ch.~\ref{#1}}
    \markright{Exercises for Ch.~\ref{#1}}%
}

% Generic practice problems section
\newcommand*{\practiceproblems}{
    \phantomsection
    \setcounter{ProbPart}{0}\section*{Practice Exercises}
    \addcontentsline{toc}{section}{Practice Exercises}
}

% Problem part command
\newcommand*{\problempart}{
    \refstepcounter{ProbPart}\textbf{Part \Alph{ProbPart}}\ 
}

% Solutions marking
\newcommand*{\solutions}{$\star$}       % Star indicates solution available
\newcommand*{\leftsolutions}{\hspace{-2.2em}\makebox[2em][l]{\solutions}}

% Solution sections
\newcommand*{\solutionsection}[1]{%
    \section*{Chapter {\ref{#1}}}%
    \addcontentsline{toc}{section}{Chapter {\ref{#1}}}%
    \markright{solutions for ch.~\ref{#1}}%
    \setcounter{countSeq}{0}
}

\newcommand*{\solutionpart}[2]{%
    \phantomsection%
    \subsection*{Chapter {\ref{#1}} Part {\ref{#2}}}%
}

% Sequence counting for solutions
\newcounter{countSeq}
\newcommand*{\nextSeq}{\stepcounter{countSeq}\arabic{countSeq}, }
\newcommand*{\noSeq}{\stepcounter{countSeq}}
\newcommand*{\lastSeq}{and \stepcounter{countSeq}\arabic{countSeq}\setcounter{countSeq}{0} }

% Environments for solutions
\newenvironment{solutioninlist}{\begin{adjustbox}{valign=t}}{\end{adjustbox}\vspace{6pt}}
\newenvironment{groupitems}{\begin{minipage}[t]{\linewidth}}{\end{minipage}}

% ========================================
% TABLE OF CONTENTS AND HEADERS
% ========================================
% Configure table of contents depth and page headers

\setcounter{tocdepth}{1}                % Show chapters and sections in TOC
\renewcommand{\thechapter}{\arabic{chapter}}
\renewcommand{\thesection}{\arabic{chapter}.\arabic{section}}

% Page style configuration
\pagestyle{fancy}
\headsep=12pt                           % Space between header and text
\headheight=15pt                        % Height of header

% Main matter page style
\fancypagestyle{mainmatter}{
\fancyhead{}                            % Clear all headers
\fancyhead[C]{\scshape \rightmark}      % Chapter title in small caps, centered
\renewcommand{\headrulewidth}{0pt}      % No line under header
}

% Front matter page style
\fancypagestyle{frontmatter}{
\fancyhead{}
\fancyhead[C]{\scshape \leftmark}
\renewcommand{\headrulewidth}{0pt}
}

% Preface page style
\fancypagestyle{prefacestyle}{
\fancyhead{}
\fancyhead[C]{\textsc{Preface}}
\renewcommand{\headrulewidth}{0pt}
}

% Appendix page style
\fancypagestyle{appendixstyle}{
\fancyhead{}
\renewcommand{\headrulewidth}{0pt}
}

% Chapter and section marks for headers
\renewcommand{\chaptermark}[1]{\markboth{\forallx}{\scshape Ch.~\thechapter\ #1}}
\renewcommand{\sectionmark}[1]{}

% Section title formatting
\titleformat{\section}{\bfseries\Large}{~\thesection}{0.5em}{}
\titleformat{\subsection}{\bfseries\large}{~\thesubsection}{0.5em}{}

% ========================================
% TRUTH TABLES
% ========================================
% Special spacing commands for typesetting truth tables

\newcommand*{\TTon}{\hspace{1.5em}\extracolsep{-1em}}   % Turn on negative column spacing
\newcommand*{\TToff}{\extracolsep{-1em}\hspace{.3em}}   % Turn off and add small space
\newcommand*{\TTbf}[1]{\textbf{#1}}                     % Bold text in truth tables

% ========================================
% NATURAL DEDUCTION
% ========================================
% Complex macro system for typesetting natural deduction proofs
% Based on fitch.sty by Peter Selinger, modified by P.D. Magnus

% Enable use of * in control sequences
{\chardef\x=\catcode`\*
\catcode`\*=11
\global\let\nd*astcode\x}
\catcode`\*=11

% Line numbering system
\newcount\nd*ctr                        % Counter for line numbers
\def\nd*render{\expandafter\ifx\expandafter\nd*x\nd*base\nd*x\the\nd*ctr\else\nd*base\ifnum\nd*ctr<0\the\nd*ctr\else\ifnum\nd*ctr>0+\the\nd*ctr\fi\fi\fi}
\expandafter\def\csname nd*-\endcsname{}

% Line number generation and referencing
\def\nd*num#1{\nd*numo{\nd*render}{#1}\global\advance\nd*ctr1}
\def\nd*numopt#1#2{\nd*numo{$#1$}{#2}}
\def\nd*numo#1#2{\edef\x{#1}\mbox{$\x$}\expandafter\global\expandafter\let\csname nd*-#2\endcsname\x}
\def\nd*ref#1{\expandafter\let\expandafter\x\csname nd*-#1\endcsname\ifx\x\relax%
  \errmessage{Undefined natdeduction reference: #1}\else\mbox{$\x$}\fi}
\def\nd*noop{}
\def\nd*set#1#2{\ifx\relax#1\nd*noop\else\global\def\nd*base{#1}\fi\ifx\relax#2\relax\else\global\nd*ctr=#2\fi}
\def\nd*reset{\nd*set{}{1}}

% Reference parsing system for comma/hyphen separated lists
\def\nd*refa#1{\nd*ref{#1}}
\def\nd*aux#1#2{\ifx#2-\nd*refa{#1}--\def\c{\nd*aux{}}%
  \else\ifx#2,\nd*refa{#1}, \def\c{\nd*aux{}}%
  \else\ifx#2;\nd*refa{#1}; \def\c{\nd*aux{}}%
  \else\ifx#2.\nd*refa{#1}. \def\c{\nd*aux{}}%
  \else\ifx#2)\nd*refa{#1})\def\c{\nd*aux{}}%
  \else\ifx#2(\nd*refa{#1}(\def\c{\nd*aux{}}%
  \else\ifx#2\nd*end\nd*refa{#1}\def\c{}%
  \else\def\c{\nd*aux{#1#2}}%
  \fi\fi\fi\fi\fi\fi\fi\c}
\def\ndref#1{\nd*aux{}#1\nd*end}        % User command for references

% Layer A: Primitive drawing elements
\newlength{\nd*dim} 
\newdimen\nd*depthdim
\newdimen\nd*hsep

% Dimension configuration command
\def\nddim#1#2#3#4#5#6#7#8{\nd*depthdim=#3\relax\nd*hsep=#6\relax%
\def\nd*height{#1}\def\nd*thickness{#8}\def\nd*initheight{#2}%
\def\nd*indent{#5}\def\nd*labelsep{#4}\def\nd*justsep{#7}}
\nddim{4.5ex}{3.5ex}{1.5ex}{1em}{1.6em}{.5em}{2.5em}{.2mm}

% Primitive elements
\def\nd*v{\rule[-\nd*depthdim]{\nd*thickness}{\nd*height}}              % Vertical line
\def\nd*t{\rule[-\nd*depthdim]{0mm}{\nd*height}\rule[-\nd*depthdim]{\nd*thickness}{\nd*initheight}}  % Top vertical line
\def\nd*i{\hspace{\nd*indent}}                                          % Indentation
\def\nd*s{\hspace{\nd*hsep}}                                            % Horizontal space
\def\nd*g#1{\nd*f{\makebox[\nd*indent][c]{$#1$}}}                      % Guard
\def\nd*f#1{\raisebox{0pt}[0pt][0pt]{$#1$}}                            % Formula
\def\nd*u#1{\makebox[0pt][l]{\settowidth{\nd*dim}{\nd*f{#1}}%          % Underlined (hypothesis)
    \addtolength{\nd*dim}{2\nd*hsep}\hspace{-\nd*hsep}\rule[-\nd*depthdim]{\nd*dim}{\nd*thickness}}\nd*f{#1}}

% List implementation for tracking proof structure
\def\nd*push#1#2{\expandafter\gdef\expandafter#1\expandafter%
  {\expandafter\nd*cons\expandafter{#1}{#2}}}
\def\nd*pop#1{{\def\nd*nil{\gdef#1{\nd*nil}}\def\nd*cons##1##2%
    {\gdef#1{##1}}#1}}
\def\nd*iter#1#2{{\def\nd*nil{}\def\nd*cons##1##2{##1#2{##2}}#1}}
\def\nd*modify#1#2#3{{\def\nd*nil{\gdef#1{\nd*nil}}\def\nd*cons##1##2%
    {\advance#2-1 ##1\advance#2 1 \ifnum#2=1\nd*push#1{#3}\else%
      \nd*push#1{##2}\fi}#1}}
\def\nd*cont#1{{\def\nd*t{\nd*v}\def\nd*v{\nd*v}\def\nd*g##1{\nd*i}%
    \def\nd*i{\nd*i}\def\nd*nil{\gdef#1{\nd*nil}}\def\nd*cons##1##2%
    {##1\expandafter\nd*push\expandafter#1\expandafter{##2}}#1}}

% Layer B: Mid-level proof construction
\newcount\nd*n
\def\nd*beginb{\begingroup\nd*reset\gdef\nd*stack{\nd*nil}\nd*push\nd*stack{\nd*t}%
  \begin{array}{l@{\hspace{\nd*labelsep}}l@{\hspace{\nd*justsep}}l}}
\def\nd*resumeb{\begingroup\begin{array}{r@{\hspace{\nd*labelsep}}l@{\hspace{\nd*justsep}}l}}
\def\nd*endb{\end{array}\endgroup}
\def\nd*hypob#1#2{\nd*f{\nd*num{#1}}&\nd*iter\nd*stack\relax\nd*cont\nd*stack\nd*s\nd*u{#2}&}
\def\nd*haveb#1#2{\nd*f{\nd*num{#1}}&\nd*iter\nd*stack\relax\nd*cont\nd*stack\nd*s\nd*f{#2}&}
\def\nd*openb{\nd*push\nd*stack{\nd*i}\nd*push\nd*stack{\nd*t}}
\def\nd*closeb{\nd*pop\nd*stack\nd*pop\nd*stack}
\def\nd*guardb#1#2{\nd*n=#1\multiply\nd*n by 2 \nd*modify\nd*stack\nd*n{\nd*g{#2}}}

% Layer C: User interface
\def\nd*clr{\gdef\nd*cmd{}}
\def\nd*sto#1#2#3{\gdef\nd*typ{#1}\gdef\nd*byt{}%
  \gdef\nd*cmd{\nd*typ{#2}{#3}\nd*byt\\}}
\def\nd*hyc#1#2{\def\nd*typ{\nd*haveb}\nd*cmd\nd*sto{\nd*hypob}{#1}{#2}}
\def\nd*hac#1#2{\nd*cmd\nd*sto{\nd*haveb}{#1}{#2}}

% Optional argument handling
\def\optarg#1#2#3{\ifx[#3\def\c{#2#3}\else\def\c{#2[#1]{#3}}\fi\c}
\def\optargg#1#2#3{\ifx[#3\def\c{#1#3}\else\def\c{#2{#3}}\fi\c}

% Complex argument parsing
\def\nd*hyx[#1][#2]#3[#4]#5{\ifx\relax#4\relax\else\nd*guardb{1}{#4}\fi\nd*hyc{#3}{#5}\nd*set{#1}{#2}}
\def\nd*hax[#1][#2]#3[#4]#5{\ifx\relax#4\relax\else\nd*guardb{1}{#4}\fi\nd*hac{#3}{#5}\nd*set{#1}{#2}}

\def\nd*five#1{\optargg{\nd*four{#1}}{\nd*two{#1}}}
\def\nd*four#1[#2]{\optarg{0}{\nd*three{#1}[#2]}}
\def\nd*three#1[#2][#3]#4{\optarg{}{#1[#2][#3]{#4}}}
\def\nd*two#1{\nd*three{#1}[\relax][]}

% Main user commands
\def\nd*have{\nd*five{\nd*hax}}
\def\nd*hypo{\nd*five{\nd*hyx}}
\def\nd*base{undefined}

\def\nd*open{\optargg{\nd*openopt}{\nd*opennoopt}}
\def\nd*openopt[#1]{\nd*cmd\nd*clr\nd*openb\nd*guard{#1}}
\def\nd*opennoopt#1{\nd*cmd\nd*clr\nd*openb#1}
\def\nd*close{\nd*cmd\nd*clr\nd*closeb}
\def\nd*guard{\optarg{1}{\nd*guardc}}
\def\nd*guardc[#1]#2{\nd*guardb{#1}{#2}}

% Justification commands
\def\nd*by#1#2{\ifx\nd*x#2\nd*x\gdef\nd*byt{\mbox{#1}}\else\gdef\nd*byt{\mbox{:\ndref{#2} #1}}\fi}
\def\nd*prs#1#2{\ifx\nd*x#2\nd*x\gdef\nd*byt{\mbox{:PR #1}}\else\gdef\nd*byt{\mbox{:\ndref{#2} #1}}\fi}
\def\nd*ass#1#2{\ifx\nd*x#2\nd*x\gdef\nd*byt{\mbox{:AS #1}}\else\gdef\nd*byt{\mbox{:\ndref{#2} #1}}\fi}
\def\nd*pr#1{\gdef\nd*byt{\mbox{:PR #1}}}  % Premise
\def\nd*as#1{\gdef\nd*byt{\mbox{:AS #1}}}  % Assumption

% Rule abbreviations initialization
\def\nd*init{%
  \let\open\nd*open%                    % Open subproof
  \let\close\nd*close%                  % Close subproof
  \let\hypo\nd*hypo%                    % Hypothesis
  \let\have\nd*have%                    % Derived line
  \let\by\nd*by%                        % Justification
  \let\pr\nd*pr%                        % Premise
  \let\as\nd*as%                        % Assumption
  \let\prs\nd*prs%                      % Premise with reference
  \let\ass\nd*ass%                      % Assumption with reference
  \let\guard\nd*guard%                  % Guard for quantifiers
  % Logical rule abbreviations
  \def\bi{\by{{\eiff}I}}%               % Biconditional introduction
  \def\be{\by{{\eiff}E}}%               % Biconditional elimination
  \def\ci{\by{{\eif}I}}%                % Conditional introduction
  \def\ce{\by{{\eif}E}}%                % Conditional elimination (modus ponens)
  \def\Ai{\by{$\forall$I}}%             % Universal introduction
  \def\Ae{\by{$\forall$E}}%             % Universal elimination
  \def\Ei{\by{$\exists$I}}%             % Existential introduction
  \def\Ee{\by{$\exists$E}}%             % Existential elimination
  \def\ae{\by{{\eand}E}}%               % Conjunction elimination
  \def\ai{\by{{\eand}I}}%               % Conjunction introduction
  \def\oi{\by{{\eor}I}}%                % Disjunction introduction
  \def\oe{\by{{\eor}E}}%                % Disjunction elimination
  \def\ni{\by{{\enot}I}}%               % Negation introduction
  \def\ne{\by{{\enot}E}}%               % Negation elimination
  \def\ii{\by{$=$I}}%                   % Identity introduction
  \def\ie{\by{$=$E}}%                   % Identity elimination
  \def\r{\by{R}}%                       % Reiteration
  \def\tnd{\by{LEM}}%                   % Law of excluded middle
  \def\ip{\by{IP}}%                     % Indirect proof
  \def\dne{\by{DNE}}%                   % Double negation elimination
  \def\mt{\by{MT}}%                     % Modus tollens
  \def\ds{\by{DS}}%                     % Disjunctive syllogism
  \def\dem{\by{DeM}}%                   % De Morgan's laws
  \def\cq{\by{CQ}}%                     % Conversion of quantifiers
  \def\re{\by{X}}%                      % Explosion (ex falso)
  \def\ellipsesline{\have[ ]{}{\vdots}}%  % Vertical dots
  \def\breakline{\have[ ]{}{\begin{tiny}-{}-\end{tiny}}}%  % Break line
}

% Natural deduction environments
\newenvironment{nd}{\begingroup\nd*init\nd*beginb\nd*clr}{\nd*cmd\nd*endb\endgroup}
\newenvironment{ndresume}{\begingroup\nd*init\nd*resumeb\nd*clr}{\nd*cmd\nd*endb\endgroup}

% Restore * catcode
\catcode`\*=\nd*astcode

% Additional proof commands
\newcommand*{\want}[1]{\by{(Want: \ensuremath{#1})}{}}  % Goal indicator
\newenvironment{iproof}{\par$\begin{nd}}{\end{nd}$\par}  % Inline proof
\renewenvironment{proof}{\par$\begin{nd}}{\end{nd}$\par} % Standard proof

% Long-form rule names
\newcommand*{\notI}{\ni}
\newcommand*{\notE}{\ne}
\newcommand*{\iffI}{\bi}
\newcommand*{\iffE}{\be}
\newcommand*{\ifI}{\ci}
\newcommand*{\ifE}{\ce}
\newcommand*{\andI}{\ai}
\newcommand*{\andE}{\ae}
\newcommand*{\orI}{\oi}
\newcommand*{\orE}{\oe}
\newcommand*{\forallI}{\Ai}
\newcommand*{\forallE}{\Ae}
\newcommand*{\existsI}{\Ei}
\newcommand*{\existsE}{\Ee}

% ========================================
% PROOF TREES CONFIGURATION
% ========================================
% Configuration for the prooftrees package

\forestset{
  % Override line numbers in proof trees
  line no override/.style={
    before drawing tree={
      for name/.process={Ow}{proof tree proof line no}{line no ##1}{
        content=\linenumberstyle{#1},
        typeset node,
      },
    },
  },
  % Suppress line numbers
  no line no/.style={
    before drawing tree={
      for name/.process={Ow}{proof tree proof line no}{line no ##1}{
        content=,
        typeset node,
      },
    },
  },
  % Vertical dots in line number position
  vdotsline/.style={
    before drawing tree={
      for name/.process={Ow}{proof tree proof line no}{line no ##1}{
        content=#1,
        typeset node,
      },
    },
  },
  % Default settings for all proof trees
  default preamble={
    single branches,                    % No branching by default
    close with=\ensuremath{\times},     % Use × for closed branches
    just sep=1.75em,                    % Space for justifications
    line no sep=1.75em                  % Space for line numbers
  }
}

% ========================================
% FITCH-STYLE PROOFS
% ========================================
% Alternative proof system using Fitch-style notation

% Dimensions for Fitch proofs
\newlength{\fitchlineht}
\setlength{\fitchlineht}{1.5\baselineskip}    % Line height
\newlength{\fitchindent}
\setlength{\fitchindent}{1em}                 % Indentation
\newlength{\fitchcomind}
\setlength{\fitchcomind}{2em}                 % Comment indentation
\newlength{\fitchnumwd}
\setlength{\fitchnumwd}{1em}                  % Line number width

% Fitch proof elements
\makeatletter
\newcommand\fvline[1][\arrayrulewidth]{\vrule\@height.5\fitchlineht\@width#1\relax}
\makeatother

\newcommand{\fa}{\vline\hspace*{\fitchindent}}       % Vertical line
\newcommand{\fb}{\fvline\hspace*{\fitchindent}}      % Short vertical line
\newcommand{\fh}{\fvline%                             % Hypothesis
  \makebox[0pt][l]{{%
      \raisebox{-1.4ex}[0pt][0pt]{\rule{1.5em}{\arrayrulewidth}}}}%
  \hspace*{\fitchindent}}
\newcommand{\fj}{\vline%                              % Multi-hypothesis
  \makebox[0pt][l]{{%
      \raisebox{-1.4ex}[0pt][0pt]{\rule{1.5em}{\arrayrulewidth}}}}%
  \hspace*{\fitchindent}}

% Modal subproofs
\newcommand{\fitchmodal}[1]{% 
  \makebox[0pt][r]{${}^{#1}$\,}\fvline\hspace*{\fitchindent}}
\newcommand{\fn}{\fitchmodal{\Box}}           % Necessary subproof
\newcommand{\fp}{\fitchmodal{\Diamond}}       % Possible subproof
\newcommand{\fitchmodalh}[1]{%                % Modal hypothesis
  \makebox[0pt][r]{${}^{#1}$\,}%
  \fvline%
  \makebox[0pt][l]{{%
      \raisebox{-1.4ex}[0pt][0pt]{\rule{1.5em}{\arrayrulewidth}}}}%
  \hspace*{\fitchindent}}

% Rule markers
\newcommand{\fr}{%                            % Rule with line
  \makebox[0pt][r]{${\rhd}$\,\,}\vline\hspace*{\fitchindent}}
\newcommand{\fs}{%                            % Rule without line
  \makebox[0pt][r]{${\rhd}$\,\,}}
\newcommand{\fw}[1]{\fbox{\footnotesize $#1$}} % Boxed variable

% Fitch counter system
\newcounter{fitchcounter}
\setcounter{fitchcounter}{0}
\newboolean{resetfitchcounter}
\setboolean{resetfitchcounter}{true}
\newboolean{increasefitchcounter}
\setboolean{increasefitchcounter}{true}
\newcommand{\formatfitchcounter}[1]{\arabic{#1}}
\newcommand{\fitchcounter}{%
  \ifthenelse{\boolean{increasefitchcounter}}{\addtocounter{fitchcounter}{1}}{}
  \formatfitchcounter{fitchcounter}}

% Special line numbering
\newcommand{\ftag}[2]{\multicolumn{1}%
  {!{\makebox[\fitchnumwd][r]{#1}\hspace{\fitchindent}}Ml@{\hspace{\fitchcomind}}}%
  {#2}}

% Fitch environments
\newenvironment{fitchnum}%                    % Numbered Fitch proof
{\ifthenelse{\boolean{resetfitchcounter}}{\setcounter{fitchcounter}{0}}{}
  \begin{tabular}{!{\makebox[\fitchnumwd][r]{\fitchcounter }\hspace{\fitchindent}}Ml@{\hspace{\fitchcomind}}l}}%
{\end{tabular}}

\newenvironment{fitchunum}%                   % Unnumbered Fitch proof
{\begin{tabular}{!{\makebox[\fitchnumwd][r]{}\hspace{\fitchindent}}Ml@{\hspace{\fitchcomind}}l}}%
{\end{tabular}}

\newenvironment{fitch}{\renewcommand{\arraystretch}{1.5}
  \begin{fitchnum}}{\end{fitchnum}}
\newenvironment{fitch*}{\renewcommand{\arraystretch}{1.5}
  \begin{fitchunum}}{\end{fitchunum}}

% Fitch lemma environment
\newenvironment{flem}[2]%
{\begin{eqnarray}
    &#1\label{#2}\\
    &\begin{fitch}}%
    {\end{fitch}\notag\end{eqnarray}}

% Two-line comment with brace
\newcommand{\ftwocom}[1]{%
  \parbox[t]{3cm}{
    \raisebox{-.6\baselineskip}[\baselineskip][0pt]{%
      $\left.
        \begin{aligned}
          \,\\ \,
        \end{aligned}
      \right\}$\quad #1}
  }}

% Additional Fitch variants
\newenvironment{kfitch}{\renewcommand{\arraystretch}{1.5}
  \begin{fitchnum}}{\end{fitchnum}}
\newenvironment{kfitch*}{\renewcommand{\arraystretch}{1.5}
  \begin{fitchunum}}{\end{fitchunum}}

% ========================================
% MISCELLANEOUS
% ========================================
% Various utility commands

\providecommand{\nix}[1]{}              % Ignore argument (like comment)
\newcommand*{\metav}[1]{\ensuremath{\mathcal{#1}}}  % Calligraphic metavariable
\newenvironment{fitchproof}              % Fitch proof with nd syntax
    {\begin{list}{}{\setlength{\leftmargin}{0pt}}\item$\begin{nd}}
    {\end{nd}$\end{list}}

% ========================================
% APPENDIX FORMATTING
% ========================================
% Special formatting for appendices

\AtAppendix{%                            % Execute at start of appendix
    \titleformat{\chapter}[display]{\vspace*{-50pt}\bfseries\huge}{Appendix~\thechapter}{0.5em}{}
    \titlespacing*{\chapter}{0pt}{0pt}{1em}
    \titleformat*{\section}{\large \bfseries}
    \titleformat*{\subsection}{\bfseries}
}

\endinput